<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poké-Arena 3D | Who's That Pokémon?</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Exo+2:wght@300;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --pokeyellow: #FFDE00;
            --pokeblue: #3B4CCA;
        }
        body {
            margin: 0;
            overflow: hidden;
            background: #020205;
            font-family: 'Exo 2', sans-serif;
            color: white;
        }
        canvas { display: block; }

        .glass {
            background: rgba(10, 20, 50, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(59, 76, 202, 0.3);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.8);
        }

        .orbitron { font-family: 'Orbitron', sans-serif; }

        /* Button Styling */
        .option-btn {
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }
        .option-btn::after {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: 0.5s;
        }
        .option-btn:hover::after { left: 100%; }
        .option-btn:hover {
            transform: scale(1.05) translateY(-5px);
            background: rgba(59, 76, 202, 0.6);
            border-color: var(--pokeyellow);
            box-shadow: 0 0 15px rgba(255, 222, 0, 0.3);
        }

        .correct { background: #10b981 !important; border-color: #34d399 !important; box-shadow: 0 0 30px #10b981; }
        .wrong { background: #ef4444 !important; border-color: #f87171 !important; }

        /* UI Overlays */
        #ui-layer {
            pointer-events: none;
        }
        #ui-layer * {
            pointer-events: auto;
        }

        /* Loading Spinner */
        .loader-ring {
            width: 80px; height: 80px;
            border: 4px solid #3B4CCA;
            border-top: 4px solid #FFDE00;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Celebration Text */
        #celebration-text {
            position: fixed;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            pointer-events: none;
            z-index: 100;
            text-shadow: 0 0 20px rgba(255, 222, 0, 0.8);
        }
    </style>
</head>
<body>

    <!-- 3D Background Container -->
    <div id="canvas-container" class="fixed inset-0 z-0"></div>

    <!-- Celebration UI -->
    <div id="celebration-text" class="orbitron text-6xl md:text-8xl font-black text-yellow-400">GREAT CATCH!</div>

    <!-- UI Overlay -->
    <div id="ui-layer" class="fixed inset-0 z-10 flex flex-col items-center justify-between p-6 md:p-12">
        
        <!-- Header -->
        <div class="w-full flex justify-between items-start">
            <div class="glass p-4 rounded-2xl">
                <h1 class="orbitron text-xl md:text-2xl font-bold text-yellow-400 tracking-widest uppercase">Poké-Arena</h1>
                <p class="text-xs opacity-60 text-blue-300">STADIUM 01 - QUANTUM FIELD</p>
            </div>
            <div class="glass p-4 rounded-2xl text-right">
                <p class="orbitron text-sm">STREAK</p>
                <p id="score-display" class="text-2xl font-bold text-yellow-400">00</p>
            </div>
        </div>

        <!-- Central Message -->
        <div class="text-center">
            <h2 id="game-status" class="orbitron text-3xl md:text-5xl font-bold mb-4 drop-shadow-lg opacity-0 transform translate-y-10 transition-all duration-500">
                WHO'S THAT POKÉMON?
            </h2>
        </div>

        <!-- Interaction Area -->
        <div class="w-full max-w-4xl">
            <div id="options-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4 opacity-0 transition-opacity duration-1000">
                <!-- Buttons injected here -->
            </div>
            
            <div id="next-container" class="mt-6 flex justify-center hidden">
                <button id="next-btn" class="orbitron glass px-12 py-4 rounded-full font-bold text-yellow-400 hover:text-white transition-colors border-2 border-yellow-400 uppercase tracking-widest">
                    Next Battle
                </button>
            </div>
        </div>
    </div>

    <!-- Preloader -->
    <div id="preloader" class="fixed inset-0 z-50 bg-black flex flex-col items-center justify-center">
        <div class="loader-ring"></div>
        <p class="orbitron mt-6 tracking-widest text-yellow-400 animate-pulse">SYNCHRONIZING POKÉDEX...</p>
    </div>

    <script>
        // --- Configuration & State ---
        const POKEMON_COUNT = 1010;
        let score = 0;
        let currentPokemon = null;
        let isRevealed = false;
        let pokemonList = [];

        // --- Three.js Setup ---
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x020205, 0.05);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.shadowMap.enabled = true;
        container.appendChild(renderer.domElement);

        // Lights
        const ambientLight = new THREE.AmbientLight(0x4040ff, 0.5);
        scene.add(ambientLight);

        const pointLight = new THREE.PointLight(0xffde00, 2, 50);
        pointLight.position.set(5, 5, 5);
        scene.add(pointLight);

        const spotLight = new THREE.SpotLight(0xffffff, 2);
        spotLight.position.set(0, 10, 5);
        spotLight.angle = Math.PI / 4;
        spotLight.penumbra = 0.1;
        scene.add(spotLight);

        // --- Background Enhancements ---

        // Digital Grid Floor
        const gridHelper = new THREE.GridHelper(100, 40, 0x3B4CCA, 0x111122);
        gridHelper.position.y = -3.05;
        scene.add(gridHelper);

        // Arena Platform
        const platformGeo = new THREE.CylinderGeometry(5, 5.5, 0.5, 64);
        const platformMat = new THREE.MeshStandardMaterial({ 
            color: 0x050505, 
            roughness: 0.05, 
            metalness: 0.9,
            emissive: 0x3B4CCA,
            emissiveIntensity: 0.5
        });
        const platform = new THREE.Mesh(platformGeo, platformMat);
        platform.position.y = -3;
        scene.add(platform);

        // Inner Glowing Disc
        const discGeo = new THREE.CircleGeometry(4.8, 64);
        const discMat = new THREE.MeshBasicMaterial({ color: 0x0a1432, transparent: true, opacity: 0.8 });
        const disc = new THREE.Mesh(discGeo, discMat);
        disc.rotation.x = -Math.PI / 2;
        disc.position.y = -2.74;
        scene.add(disc);

        // Neon Rings
        const rings = [];
        for(let i=0; i<3; i++) {
            const ringGeo = new THREE.TorusGeometry(5 + i*0.2, 0.03, 16, 100);
            const ringMat = new THREE.MeshBasicMaterial({ color: 0x3B4CCA, transparent: true, opacity: 0.5 - i*0.1 });
            const ring = new THREE.Mesh(ringGeo, ringMat);
            ring.rotation.x = Math.PI / 2;
            ring.position.y = -2.7;
            scene.add(ring);
            rings.push(ring);
        }

        // Starfield Particles
        const particlesCount = 2000;
        const posArray = new Float32Array(particlesCount * 3);
        const colorArray = new Float32Array(particlesCount * 3);
        for(let i=0; i < particlesCount * 3; i++) {
            posArray[i] = (Math.random() - 0.5) * 60;
            colorArray[i] = Math.random();
        }
        const particlesGeo = new THREE.BufferGeometry();
        particlesGeo.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
        particlesGeo.setAttribute('color', new THREE.BufferAttribute(colorArray, 3));
        const particlesMat = new THREE.PointsMaterial({ 
            size: 0.04, 
            vertexColors: true, 
            transparent: true, 
            opacity: 0.8,
            blending: THREE.AdditiveBlending 
        });
        const particlesMesh = new THREE.Points(particlesGeo, particlesMat);
        scene.add(particlesMesh);

        // Celebration Particle System
        const confettiCount = 300;
        const confettiGeo = new THREE.BufferGeometry();
        const confPos = new Float32Array(confettiCount * 3);
        const confVel = new Float32Array(confettiCount * 3);
        for(let i=0; i < confettiCount * 3; i++) {
            confPos[i] = 0;
            confVel[i] = (Math.random() - 0.5) * 0.2;
        }
        confettiGeo.setAttribute('position', new THREE.BufferAttribute(confPos, 3));
        const confettiMat = new THREE.PointsMaterial({ size: 0.1, color: 0xffde00, transparent: true, opacity: 0 });
        const confettiMesh = new THREE.Points(confettiGeo, confettiMat);
        scene.add(confettiMesh);

        // --- Pokemon Shader (Rim Highlight for better visibility) ---
        let pokemonSprite = null;

        const shaderMaterial = new THREE.ShaderMaterial({
            uniforms: {
                uTexture: { value: null },
                uBrightness: { value: 0.0 }, 
                uAlpha: { value: 0.0 },
                uTime: { value: 0.0 }
            },
            transparent: true,
            vertexShader: `
                varying vec2 vUv;
                void main() {
                    vUv = uv;
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                }
            `,
            fragmentShader: `
                uniform sampler2D uTexture;
                uniform float uBrightness;
                uniform float uAlpha;
                uniform float uTime;
                varying vec2 vUv;

                void main() {
                    vec4 tex = texture2D(uTexture, vUv);
                    
                    // Silhouette rim-glow logic
                    float edge = 0.0;
                    if (uBrightness < 0.1) {
                        float dist = 0.015;
                        float a1 = texture2D(uTexture, vUv + vec2(dist, 0.0)).a;
                        float a2 = texture2D(uTexture, vUv - vec2(dist, 0.0)).a;
                        float a3 = texture2D(uTexture, vUv + vec2(0.0, dist)).a;
                        float a4 = texture2D(uTexture, vUv - vec2(0.0, dist)).a;
                        edge = (abs(a1 - tex.a) + abs(a2 - tex.a) + abs(a3 - tex.a) + abs(a4 - tex.a));
                    }

                    vec3 rimColor = vec3(0.3, 0.5, 1.0) * (0.5 + 0.5 * sin(uTime * 3.0));
                    vec3 baseColor = mix(rimColor * edge, tex.rgb, uBrightness);
                    
                    gl_FragColor = vec4(baseColor, tex.a * uAlpha);
                }
            `
        });

        function createPokemonMesh() {
            const geo = new THREE.PlaneGeometry(5, 5);
            pokemonSprite = new THREE.Mesh(geo, shaderMaterial);
            pokemonSprite.position.y = 0.5;
            scene.add(pokemonSprite);
        }

        camera.position.z = 8;
        camera.position.y = 1;

        // --- Game Logic ---

        async function initGame() {
            try {
                const res = await fetch(`https://pokeapi.co/api/v2/pokemon?limit=${POKEMON_COUNT}`);
                const data = await res.json();
                pokemonList = data.results;
                createPokemonMesh();
                document.getElementById('preloader').style.display = 'none';
                startNewRound();
            } catch (e) {
                console.error("Failed to load Pokemon database", e);
            }
        }

        async function startNewRound() {
            isRevealed = false;
            confettiMat.opacity = 0;
            
            // UI Resets
            const status = document.getElementById('game-status');
            status.style.opacity = '0';
            status.style.transform = 'translateY(20px)';
            status.textContent = "WHO'S THAT POKÉMON?";
            status.style.color = 'white';
            
            document.getElementById('options-grid').style.opacity = '0';
            document.getElementById('next-container').classList.add('hidden');
            
            // Pick Random Pokemon
            const correctIndex = Math.floor(Math.random() * POKEMON_COUNT);
            const correctData = pokemonList[correctIndex];
            
            // Get choices
            const choices = [correctData];
            while(choices.length < 4) {
                const rand = pokemonList[Math.floor(Math.random() * POKEMON_COUNT)];
                if(!choices.includes(rand)) choices.push(rand);
            }
            choices.sort(() => Math.random() - 0.5);

            // Fetch Image
            const detailRes = await fetch(correctData.url);
            const detail = await detailRes.json();
            const imgUrl = detail.sprites.other['official-artwork'].front_default || detail.sprites.front_default;
            
            currentPokemon = {
                name: correctData.name.toUpperCase(),
                img: imgUrl
            };

            // Update Texture
            const loader = new THREE.TextureLoader();
            loader.load(imgUrl, (texture) => {
                shaderMaterial.uniforms.uTexture.value = texture;
                
                // Entrance Animation
                gsap.to(shaderMaterial.uniforms.uAlpha, { value: 1, duration: 1 });
                gsap.to(shaderMaterial.uniforms.uBrightness, { value: 0, duration: 0.1 });
                gsap.fromTo(pokemonSprite.position, { y: 10 }, { y: 0.5, duration: 1.2, ease: "bounce.out" });
                
                renderButtons(choices);
                
                // Show UI
                gsap.to(status, { opacity: 1, y: 0, duration: 0.5, delay: 1 });
                gsap.to(document.getElementById('options-grid'), { opacity: 1, duration: 0.5, delay: 1.2 });
            });
        }

        function renderButtons(choices) {
            const grid = document.getElementById('options-grid');
            grid.innerHTML = '';
            choices.forEach(poke => {
                const btn = document.createElement('button');
                btn.className = 'option-btn orbitron glass p-4 md:p-6 rounded-xl font-bold tracking-widest text-lg border-2 border-transparent';
                btn.textContent = poke.name.toUpperCase();
                btn.onclick = () => handleGuess(btn, poke.name.toUpperCase());
                grid.appendChild(btn);
            });
        }

        function handleGuess(btn, name) {
            if(isRevealed) return;
            isRevealed = true;

            const isCorrect = name === currentPokemon.name;
            const status = document.getElementById('game-status');
            
            // Visual Reveal
            gsap.to(shaderMaterial.uniforms.uBrightness, { value: 1, duration: 0.8, ease: "power2.out" });
            gsap.to(camera.position, { z: 6, duration: 1 });

            if(isCorrect) {
                score++;
                document.getElementById('score-display').textContent = score.toString().padStart(2, '0');
                btn.classList.add('correct');
                status.textContent = `CORRECT! IT'S ${currentPokemon.name}`;
                status.style.color = '#10b981';
                celebrate();
            } else {
                btn.classList.add('wrong');
                status.textContent = `IT'S ${currentPokemon.name}!`;
                status.style.color = '#ef4444';
                // Highlight correct one
                Array.from(document.querySelectorAll('.option-btn')).forEach(b => {
                    if(b.textContent === currentPokemon.name) b.classList.add('correct');
                });
            }

            document.getElementById('next-container').classList.remove('hidden');
        }

        function celebrate() {
            // Particle explosion
            confettiMat.opacity = 1;
            const positions = confettiGeo.attributes.position.array;
            for(let i=0; i<confettiCount*3; i++) {
                positions[i] = (Math.random() - 0.5) * 2;
            }
            confettiGeo.attributes.position.needsUpdate = true;

            // Text animation
            const celebText = document.getElementById('celebration-text');
            gsap.fromTo(celebText, 
                { scale: 0, opacity: 1, y: 50 }, 
                { scale: 1, opacity: 1, y: 0, duration: 0.6, ease: "back.out(1.7)" }
            );
            gsap.to(celebText, { opacity: 0, scale: 1.5, duration: 1, delay: 1.5 });
            
            // Screen shake
            gsap.to(camera.position, { 
                x: 0.2, y: 1.2, duration: 0.05, repeat: 10, yoyo: true,
                onComplete: () => { camera.position.x = 0; camera.position.y = 1; }
            });
        }

        // --- Animation Loop ---
        let mouseX = 0;
        let mouseY = 0;
        window.addEventListener('mousemove', (e) => {
            mouseX = (e.clientX / window.innerWidth - 0.5) * 2;
            mouseY = (e.clientY / window.innerHeight - 0.5) * 2;
        });

        function animate() {
            requestAnimationFrame(animate);
            const time = performance.now() * 0.001;
            shaderMaterial.uniforms.uTime.value = time;
            
            // Subtle floating motion
            if(pokemonSprite) {
                pokemonSprite.position.y += Math.sin(time * 2) * 0.005;
                pokemonSprite.rotation.y = THREE.MathUtils.lerp(pokemonSprite.rotation.y, mouseX * 0.3, 0.1);
            }

            // Move camera based on mouse
            camera.position.x = THREE.MathUtils.lerp(camera.position.x, mouseX * 2.5, 0.05);
            camera.lookAt(0, 0, 0);

            // Rotate platform bits
            rings.forEach((r, i) => {
                r.rotation.z += 0.01 * (i + 1);
            });
            particlesMesh.rotation.y += 0.0005;

            // Update Confetti
            if(confettiMat.opacity > 0) {
                const pos = confettiGeo.attributes.position.array;
                for(let i=0; i<confettiCount; i++) {
                    pos[i*3+1] += 0.05; // Fall upwards
                    pos[i*3] += Math.sin(time + i) * 0.02;
                }
                confettiGeo.attributes.position.needsUpdate = true;
                confettiMat.opacity -= 0.005;
            }

            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        document.getElementById('next-btn').onclick = () => {
            gsap.to(camera.position, { z: 8, duration: 1 });
            gsap.to(shaderMaterial.uniforms.uAlpha, { 
                value: 0, 
                duration: 0.5, 
                onComplete: startNewRound 
            });
        };

        window.onload = () => {
            initGame();
            animate();
        };

    </script>
</body>
</html>
